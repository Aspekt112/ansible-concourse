#!/bin/bash
# {{ ansible_managed }}
# Config
{% macro build_option(option, value='omit') %}
{% if value != 'omit' %}
export {{ option }}={{ value }}
{% endif %}
{% endmacro %}

{{ build_option("CONCOURSE_NAME", CONCOURSE_WORKER_NAME | default("omit")) -}}
{{ build_option("CONCOURSE_TAG", CONCOURSE_WORKER_TAG | default("omit")) -}}
{{ build_option("CONCOURSE_TEAM", CONCOURSE_WORKER_TEAM | default("omit")) -}}
{{ build_option("http_proxy", http_proxy | default("omit")) -}}
{{ build_option("https_proxy", https_proxy | default("omit")) -}}
{{ build_option("no_proxy", no_proxy | default("omit")) -}}
{{ build_option("CONCOURSE_WORK_DIR", CONCOURSE_WORKER_WORK_DIR | default("omit")) -}}
{{ build_option("CONCOURSE_BIND_IP", CONCOURSE_WORKER_BIND_IP | default("omit")) -}}
{{ build_option("CONCOURSE_BIND_PORT", CONCOURSE_WORKER_BIND_PORT | default("omit")) -}}
{{ build_option("CONCOURSE_PEER_IP", CONCOURSE_WORKER_PEER_IP | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_LOG_LEVEL", CONCOURSE_WORKER_GARDEN_LOG_LEVEL | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_BIND_IP", CONCOURSE_WORKER_GARDEN_BIND_IP | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_BIND_PORT", CONCOURSE_WORKER_GARDEN_BIND_PORT | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_BIND_SOCKET", CONCOURSE_WORKER_GARDEN_BIND_SOCKET | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DEBUG_BIND_IP", CONCOURSE_WORKER_GARDEN_DEBUG_BIND_IP | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DEBUG_BIND_PORT", CONCOURSE_WORKER_GARDEN_DEBUG_BIND_PORT | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_TAG", CONCOURSE_WORKER_GARDEN_TAG | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_ROOTLESS", CONCOURSE_WORKER_GARDEN_ROOTLESS | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DEPOT", CONCOURSE_WORKER_GARDEN_DEPOT | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_PROPERTIES_PATH", CONCOURSE_WORKER_GARDEN_PROPERTIES_PATH | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DEFAULT_ROOTFS", CONCOURSE_WORKER_GARDEN_DEFAULT_ROOTFS | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DEFAULT_GRACE_TIME", CONCOURSE_WORKER_GARDEN_DEFAULT_GRACE_TIME | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DESTROY_CONTAINERS_ON_STARTUP", CONCOURSE_WORKER_GARDEN_DESTROY_CONTAINERS_ON_STARTUP | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_APPARMOR", CONCOURSE_WORKER_GARDEN_APPARMOR | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DADOO_BIN", CONCOURSE_WORKER_GARDEN_DADOO_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_NSTAR_BIN", CONCOURSE_WORKER_GARDEN_NSTAR_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_TAR_BIN", CONCOURSE_WORKER_GARDEN_TAR_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_IPTABLES_BIN", CONCOURSE_WORKER_GARDEN_IPTABLES_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_INIT_BIN", CONCOURSE_WORKER_GARDEN_INIT_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_RUNC_BIN", CONCOURSE_WORKER_GARDEN_RUNC_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_IMAGE_PLUGIN", CONCOURSE_WORKER_GARDEN_IMAGE_PLUGIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_GRAPH", CONCOURSE_WORKER_GARDEN_GRAPH | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_GRAPH_CLEANUP_THRESHOLD_IN_MEGABYTES", CONCOURSE_WORKER_GARDEN_GRAPH_CLEANUP_THRESHOLD_IN_MEGABYTES | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_PERSISTENT_IMAGE", CONCOURSE_WORKER_GARDEN_PERSISTENT_IMAGE | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DOCKER_REGISTRY", CONCOURSE_WORKER_GARDEN_DOCKER_REGISTRY | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_INSECURE_DOCKER_REGISTRY", CONCOURSE_WORKER_GARDEN_INSECURE_DOCKER_REGISTRY | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_NETWORK_POOL", CONCOURSE_WORKER_GARDEN_NETWORK_POOL | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_ALLOW_HOST_ACCESS", CONCOURSE_WORKER_GARDEN_ALLOW_HOST_ACCESS | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DENY_NETWORK", CONCOURSE_WORKER_GARDEN_DENY_NETWORK | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_ALLOW_NETWORK", CONCOURSE_WORKER_GARDEN_ALLOW_NETWORK | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DNS_SERVER", CONCOURSE_WORKER_GARDEN_DNS_SERVER | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_EXTERNAL_IP", CONCOURSE_WORKER_GARDEN_EXTERNAL_IP | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_PORT_POOL_START", CONCOURSE_WORKER_GARDEN_PORT_POOL_START | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_PORT_POOL_SIZE", CONCOURSE_WORKER_GARDEN_PORT_POOL_SIZE | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_PORT_POOL_PROPERTIES_PATH", CONCOURSE_WORKER_GARDEN_PORT_POOL_PROPERTIES_PATH | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_MTU", CONCOURSE_WORKER_GARDEN_MTU | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_NETWORK_PLUGIN", CONCOURSE_WORKER_GARDEN_NETWORK_PLUGIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_NETWORK_PLUGIN_EXTRA_ARG", CONCOURSE_WORKER_GARDEN_NETWORK_PLUGIN_EXTRA_ARG | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_MAX_CONTAINERS", CONCOURSE_WORKER_GARDEN_MAX_CONTAINERS | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_METRICS_EMISSION_INTERVAL", CONCOURSE_WORKER_GARDEN_METRICS_EMISSION_INTERVAL | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DROPSONDE_ORIGIN", CONCOURSE_WORKER_GARDEN_DROPSONDE_ORIGIN | default("omit")) -}}
{{ build_option("CONCOURSE_GARDEN_DROPSONDE_DESTINATION", CONCOURSE_WORKER_GARDEN_DROPSONDE_DESTINATION | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_BIND_IP", CONCOURSE_WORKER_BAGGAGECLAIM_BIND_IP | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_BIND_PORT", CONCOURSE_WORKER_BAGGAGECLAIM_BIND_PORT | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_VOLUMES", CONCOURSE_WORKER_BAGGAGECLAIM_VOLUMES | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_DRIVER", CONCOURSE_WORKER_BAGGAGECLAIM_DRIVER | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_BTRFS_BIN", CONCOURSE_WORKER_BAGGAGECLAIM_BTRFS_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_MKFS_BIN", CONCOURSE_WORKER_BAGGAGECLAIM_MKFS_BIN | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_REAP_INTERVAL", CONCOURSE_WORKER_BAGGAGECLAIM_REAP_INTERVAL | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_YELLER_API_KEY", CONCOURSE_WORKER_BAGGAGECLAIM_YELLER_API_KEY | default("omit")) -}}
{{ build_option("CONCOURSE_BAGGAGECLAIM_YELLER_ENVIRONMENT", CONCOURSE_WORKER_BAGGAGECLAIM_YELLER_ENVIRONMENT | default("omit")) -}}
{{ build_option("CONCOURSE_TSA_HOST", CONCOURSE_WORKER_TSA_HOST | default("omit")) -}}
{{ build_option("CONCOURSE_TSA_PORT", CONCOURSE_WORKER_TSA_PORT | default("omit")) -}}
{{ build_option("CONCOURSE_TSA_PUBLIC_KEY", CONCOURSE_WORKER_TSA_PUBLIC_KEY | default("omit")) -}}
{{ build_option("CONCOURSE_TSA_WORKER_PRIVATE_KEY", CONCOURSE_WORKER_TSA_WORKER_PRIVATE_KEY | default("omit")) -}}
{{ build_option("CONCOURSE_YELLER_API_KEY", CONCOURSE_WORKER_YELLER_API_KEY | default("omit")) -}}
{{ build_option("CONCOURSE_YELLER_ENVIRONMENT", CONCOURSE_WORKER_YELLER_ENVIRONMENT | default("omit")) -}}

# concourse worker
exec {{ concourseci_bin_dir }}/concourse worker &>> {{ concourseci_log_worker }}
